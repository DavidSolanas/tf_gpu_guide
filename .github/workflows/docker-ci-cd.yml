# CI workflow: build, smoke-test and optionally push a TensorFlow GPU Docker image.
# Triggers: pushes to main branch and tags starting with `v`.
name: Build & Test Docker TensorFlow GPU

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        id: build
        run: |
          IMAGE_NAME=tf-gpu-img
          IMAGE_TAG=${GITHUB_SHA::7}
          echo "Building ${IMAGE_NAME}:${IMAGE_TAG}"
          docker build -t ${IMAGE_NAME}:${IMAGE_TAG} -f Dockerfile .
          echo "image_name=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT

      - name: Run smoke test (verify TF in image)
        # Note: GitHub runners do not expose GPUs. This step verifies TF is present inside the image.
        run: |
          IMAGE_NAME=${{ steps.build.outputs.image_name }}
          IMAGE_TAG=${{ steps.build.outputs.image_tag }}
          docker run --rm ${IMAGE_NAME}:${IMAGE_TAG} \
            python -c "import tensorflow as tf; print('TF', tf.__version__); print('GPUs', tf.config.list_physical_devices('GPU'))"

      - name: Test model file exists in image
        run: |
          IMAGE_NAME=${{ steps.build.outputs.image_name }}
          IMAGE_TAG=${{ steps.build.outputs.image_tag }}
          docker run --rm ${IMAGE_NAME}:${IMAGE_TAG} \
            ls -lh /app/models/model.keras

      - name: Save image as tar and upload artifact
        run: |
          IMAGE_NAME=${{ steps.build.outputs.image_name }}
          IMAGE_TAG=${{ steps.build.outputs.image_tag }}
          docker save ${IMAGE_NAME}:${IMAGE_TAG} -o image_${IMAGE_TAG}.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image-tar
          path: image_*.tar
          retention-days: 7

# Optional push steps removed â€” keep your build_and_push.sh for future use if you decide to push images.
# See scripts/build_and_push.sh for multi-cloud registry push support (AWS ECR, Azure ACR, GCP GCR)