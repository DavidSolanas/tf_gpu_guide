name: API Integration Tests

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  test-api:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install test dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest requests
    
    - name: Train dummy model for CI
      run: |
        # Create models directory
        mkdir -p models
        # Install TensorFlow to train model
        pip install tensorflow==2.16.1
        # Train a simple model (use local models dir, not /app/models)
        python src/train_model.py --epochs 1 --model-dir ./models
        # Verify model was created
        ls -lh models/
    
    - name: Build Docker image
      run: |
        docker build -t tf-gpu-api:test -f Dockerfile .
    
    - name: Start API container
      run: |
        docker run -d \
          --name tf-gpu-api-test \
          -p 8000:8000 \
          tf-gpu-api:test
        
        # Wait for container to be healthy
        echo "Waiting for API to be ready..."
        for i in {1..30}; do
          if curl -f http://localhost:8000/health > /dev/null 2>&1; then
            echo "API is ready!"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 2
        done
    
    - name: Check container logs
      if: always()
      run: |
        docker logs tf-gpu-api-test
    
    - name: Run API integration tests
      run: |
        pytest tests/test_api_integration.py -v --tb=short
      env:
        API_URL: http://localhost:8000
    
    - name: Stop and remove container
      if: always()
      run: |
        docker stop tf-gpu-api-test || true
        docker rm tf-gpu-api-test || true
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pytest-results
        path: |
          pytest-report.xml
          pytest-coverage.txt
        retention-days: 30
